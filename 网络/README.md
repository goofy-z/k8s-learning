## Go 夜读第 68 期网络知识十全大补丸

本期 Go 夜读是由刘楠给大家带来的『网络知识十全大补丸』。

### 作者介绍

刘楠 (NandyLiu)，曾经的少年黑客，大学时的计算机学院网管，毕业后曾在某前沿网络设备厂商研发网络安全和流控产品，解决了行业性的网络流控难题，在中美两国有流控算法专利，[Network traffic control method and device(CN 102355425, US 8,804,525 B2)](https://worldwide.espacenet.com/publicationDetails/biblio?CC=CN&NR=102355425A&KC=A&FT=D). 后又在多个行业的头部企业任职，为亿级在线的国民聊天软件优化网络调度和传输体验，为金融市场开发高性能高实时性的金融行情系统。出身于教师世家，生活成长于校园，乐于传道和分享自己的想法。

### 背景

后端工程师在工作中经常会遇到计算机网络方面的问题，网络对多数人来说还是一个黑盒子，本次技术分享从常见的网络硬件、企业和数据中心的网络拓扑、Linux 协议栈和防火墙等基础网络知识开始介绍，一直讲到 TCP 和 HTTP 这些年的技术演进路线和未来趋势。

### 大纲

- 网络硬件介绍
- 网络部署模式
- Linux 协议栈
- Linux 防火墙
- 前沿网络传输技术

----

## QA

> ### 1. tap 是虚拟网卡吗?

虚拟网卡有很多种，比如 loopback 的 lo，docker 容器的 veth，tap 也是其中一种。

> ### 2. https 也能检测到数据包吗?

https 因为有加密所以一般不能检测数据包，强行检测需要使用中间人攻击伪造证书，会被客户端发现。

> ### 3. 老师想问下，跨网通讯，目的 mac 地址只填网关 mac 地址就可以了么，然后让网关自己去跳?
> 发往同网段的话通过 arp 或路由表填充目的 mac 地址，那么发送跨网段数据包-目的 mac 地址不需要填直接发给网关么，让网关来跳

本机通过路由，把跨网段的数据包在二层发给网关，所以目的MAC地址是网关的MAC地址，网关收到这个数据包后进入自己的协议栈的第三层，查找路由转发给下一跳的节点。

> ### 4. mac 地址不是随着数据包换的吗？

MAC 地址是二层网络使用的地址，二层网络属于一个邻居系统，只支持邻居之间的通信，所以 MAC 地址在二层网络中转发时不变，跨越二层经过三层设备的时候就会改变。

> ### 5. 网关与网桥感觉很像?

网关工作于三层，网桥工作于二层，网关是内网和外网之间的三层路由节点，网桥将两个二层网络连接为一个更大的二层网络。

> ### 6. 我觉得 VPN 和电路层代理很像，大佬可以讲讲？

VPN 工作于三层或以上，电路层代理是什么概念？是想问 socket 代理吗？四层的 SSL VPN 跟 socket 代理从概念到使用的技术都非常类似。

> ### 7. 请问一个问题，最近发现集群的网卡 drop 包很多，我们监控了一下平均每分钟都有几个，会有哪些问题导致的呢？驱动会不会影响这个参数？

drop 的原因很多，流量太大，负载过高，网卡的 buffer 满了，就可能会 drop，可以通过降低流量来观察 drop 会不会减少并消失。

> ### 8. 混杂模式下抓也会漏包

一般不会漏，不过上层的交换机如果只把属于抓包的这台机器的数据包转发过来，不属于你的数据你就抓不到了。如果想抓整个局域网的数据包，要使用ARP欺骗技术，把自己伪装成局域网的网关，实现中间人攻击。

> 1. 看一下上层是不是收不过来了
> 2. mtu？

有 mtu 问题的可能性，不过也不是太大。

> ### 9. 软中断就是 汇编中的 int 吧
> 中断下半部
> Int 就是一个中断指令吧

软中断这个概念是用来处理中断任务的下半部(bottom half)，简化硬件中断程序的处理逻辑，让硬中断程序只处理简单的 IO 操作，之后复杂的逻辑留给软中断程序来处理，减少硬中断占用 CPU 的时间，提高 CPU 对其他中断的处理实时性，简单的说就是一个任务分成两部分，上半部分是紧急处理阶段，下半部分是非紧急处理阶段，下半部分在具体实现上可以使用软中断的模式，软中断可以用 int 指令来主动触发，从而让 CPU 来处理下半部的逻辑。

> ### 10. I/O 的 select 还是 poll 模式，是在哪个环节有区别呢？

select 和 poll 用来操作 socket，是协议栈传输层以上的处理逻辑，用于轮询 socket，检查轮询的一批 socket 的发送和接受缓冲区是否可读可写。

> ### 11. 老师对 dpdk 了解吗 一直不知道处于哪个步骤

dpdk 技术在网卡驱动程序中就已经介入，网卡收发数据包直接使用 dpdk 设定好的内存区域，这个内存区域再映射到应用层，实现应用层直接与网卡驱动的数据交换，绕过操作系统协议栈，实现高性能网络数据处理

> cpu 绑定？
> 硬直通 ovs evs 都可以绑定 cpu

可以通过二进制掩码的形式，实现 IRQ Affinity，指定中断由哪些 CPU 来处理，也叫中断的 CPU 绑定

> ### 12. local_in 就是 iptables 的 input 链吧

是的

> ### 13. iptables 可以用来做限速吗？比如模拟丢包，弱网
> tc

tc 命令用于在二层构建数据发送队列，支持队列的各种调度，比如增加延时，设定丢包的概率模型，可以模拟常见的网络场景，实际上很多广域网模拟器的硬件，就是通过 linux + tc 在一个嵌入式的小盒子里实现的。

> ### 14. mangle 表一般可以做一些什么事情

用于对数据包进行修改，比如修改 IP 包头的 TTL 字段

> ### 15. 劫持是用 mangle 吗？

mangle 通常只对单个包做简单的修改，复杂的劫持逻辑不方便在内核中实现，一般会在 nat 中做一个 dnat，将需要劫持的流量的目的 IP 定向到本机，然后在本机监听对应的端口，实现中间人或代理劫持。

> ### 16. 那个经典了计算机网络的绿皮书讲 tcp 很不错
> ### 17.
> https://www.7down.com/soft/179692.html
>
> ### 18. bbr 一般用于 1080 优化？

bbr 可以抗丢包，在有丢包的情况下依然能保持大带宽，所以对于 1080p 或更高清的视频传输，也是有很好的效果的。

> ### 19. 我在公司让 sa 帮忙把一台机器设置了 BBR，升级了内核，但是用 iperf 测试效果不是很好，一直没算弄清楚原因
> sysctl -w net.ipv4.tcp_congestion_control=bbr

先要检查看你内核使用的是不是 BBR 算法，另外 BBR 只对发送端有效果，如果你开启BBR的是接收端，发送端没有开启 BBR，是没有意义的。BBR 最大的优势在于抗丢包，如果网络中没有随机丢包(非拥塞导致的丢包)，BBR 相对传统 TCP 算法并没有明显优势。

> ### 20. 有比 BBR 更优秀的？

拥塞控制算法有自己的适用场景，另外是否优秀也有很多评价标准，有人认为 BBR 还不够激进，需要提高侵略性，也有人认为 BBR 抢占其他算法的带宽不公平。

> ### 21. 插个问题，我们用 1.1，但是也用了 WSS，这个时候 WSS 不知道是握手还是连接超时，到了六秒中，这个时候同一个页面其他的请求都没有收到，这个应该是 1.1 中阻塞了吧
> > 我们用 1.1，但是也用了 WSS，这个时候 WSS 不知道是握手还是连接超时，到了六秒中，这个时候同一个页面其他的请求都没有收到，这个应该是 1.1 中阻塞了吧？建立连接的时候 WS 还是 HTTP 协议，只不过走 upgrade 升级，服务端收到 upgrade 后切换协议，大概这样的，WS 刚刚通过 HTTP 传的时候会不会新建 TCP？
>
> 不一定 ws会和页面其他请求用不同的 tcp 连接

websocket 会一直使用同一条 TCP 连接，你说的超时是晚到还是一直没有到？如果是一直不到，可能中间的链路对 websocket 有干扰，比如企业网出口的 http 代理，有可能把 websocket 当做普通 http 请求来处理，不支持 websocket 的 upgrade 操作，建议排查客户端的网络环境，比如让客户端通过手机开热点上网，对照测试，用排除法排查。

FEC也是一种纠错算法

> 那 fec 包也丢了咋办?

FEC 不是正常的业务包，丢了不影响业务的传输，没有关系。加入多少比例的 FEC 要看实际丢包率，FEC 要有足够的比例来填丢包的坑。

![企业微信截图_8a69d46c-2fbe-4bf7-b54d-069a8b33cffa](/Users/a/Library/Containers/com.tencent.WeWorkMac/Data/Library/Application Support/WXWork/Temp/ScreenCapture/企业微信截图_8a69d46c-2fbe-4bf7-b54d-069a8b33cffa.png)

## 参考资料

1. W・Richard Stevens, TCP/IP 详解 卷 1：协议，TCP/IP ILLustrated Volume 1: The Protocols, 1994
2. Christian Benvenuti, 深入理解 LINUX 网络技术内幕，Understanding Linux Network Internals, 2005
3. Gnv Vibhav Reddy, G.Vijay Kumar, L.Roshini, Congestions and Control Mechanisms in Wired and Wireless Networks, 2014
4. Neal Cardwell, Yuchung Cheng, BBR: Congestion-Based Congestion Control, acmqueue, 2016
5. QUIC: a multiplexed stream transport over UDP, https://www.chromium.org/quic
6. HTTP/3: draft-ietf-quic-http-latest, https://quicwg.org/base-drafts/draft-ietf-quic-http.html

---

## 观看视频



## 视频记录

###基础网络设备（一到三层）

- 集线器（Hub）：工作在一层，复制转发多路数字信号，有些交换机也会具备该功能。

- 以太网供电PoE（Power over Ethernet）：通过网线给网络设备供电，IP电话机，无线AP，部分交换机可以通过网线供电不需要额外电源。

- 交换机（Switch）：包括用于小型局域网的二层交换机和大型局域网的三层交换机

  二层交换机工作与二层，用于隔离局域网，比如说一个公司有多个楼层，给他们分配到不同的vlan，做一个网络的隔离，避免一个网络里面的广播或数据包发到所有机器上去。而三层交换机则再二层基础上又具备了路由转发的功能。

- 网桥（Bridge）：与交换机非常类似，工作与二层网络用语连接多个局域网，通常端口数量较少，常见于虚拟网桥应用场景，比如docker0网桥。

  虚拟网卡包括：TAP，回环地址：127.0.0.1的网卡，docker上的veth(虚拟网卡)

- 路由器Router：工作在三层，通过路由寻址，连接不通以太网，用路由协议为报文提供路由。

  使用路由器来跨三层通信，二层通信只能使用mac地址。	



### 高级网络设备(三层以上)

- 防火墙（Firewall）：硬件防火墙，用于网络之间的风险隔离，传统防火墙工作于三层，更前沿的防火墙可以工作在四层和七层，比如支持DPI的深度包监测防火墙

  传统防火墙是封IP和端口；应用层防火墙可以检测数据包内容（DPI）从而过滤内容，但不会处理https，https 因为有加密所以一般不能检测数据包，强行检测需要使用中间人攻击伪造证书，会被客户端发现。

- 虚拟专用网（VPN）：在公网上假设的虚拟加密通信网络，常见的两种形式是：终端远程接入私有网络，两个私有网络的互联互通

  SSL：在你的本地开一个应用层代理，将访问公司的域名映射到本地的IP的80端口，在本地监听这个端口。

  两个私有网络互通：一个网络架设vpn设备，连接另一个vpn设备。

- 网关（Gateway）：网络的出口设备，工作于三层或以上，可以集合路由，防火墙、流程，VPN，多运营商宽带的流量负载均衡等功能与一体。

  网关与网桥，后者工作于二层，且是局域网，但网关是在三层，内网和外网隔离。

- 无线接入点AP：运行WIFI系列协议802.11.的二层网络设备，相当于无线网络的交换机，可以支持移动终端在多个接入点之间的无缝漫游。

  

###网络部署模式

- 小型企业网络

  办公电脑 --> 接入层交换机（一个部门一个网络） --> 聚合层交换机（不同部门之间交换, 可能会有多个，防止挂掉）--> 路由器（网关or防火墙）--> 运营商交换机。

- 带VPN的企业网

  办公室网络 --> VPN设备 --> 公网设备 --> 另一个私有网络VPN --> 另一个办公室网络。

  个人通过SSL连接到办公室网络。

- 数据中心网络

  服务器 --> 机架顶的接入层交换机 --> 聚合层交换机 --> 核心交换机（三层）。

### Linux协议栈收包流程

1. 数据包到达网卡NIC（Network Interface Card）

2. NIC校验MAC地址（网卡非混杂模式）和帧的校验字段FCS

   非混杂模式会把目的地址不是自己，数据包就会drop。通常在使用虚拟机的桥接网络，软件会把网卡设成非混杂，另外就是一些抓包工具

   FCS是二层网络帧上的校验字段，如果FCS和网卡计算的值不一样就会认为数据丢失，drop该数据。

   网络数据报损坏：无线网络受电磁波干扰，流量太大，负载过高，网卡的 buffer 满了，就可能会 drop，可以通过降低流量来观察 drop 会不会减少并消失。

3. NIC通过DMA将数据包放入提前映射好的内存区域

4. NIC将数据包的引用放入接收的ring buffer队列rx中

5. NIC等待rx-usecs（微秒）的超时时间或者rx队列长度达到rx-frames后触发硬件中断IRQ

6. CPU执行硬件中断和网卡的驱动程序

7. 驱动程序清理硬件中断，并处罚软中断NET_RX_SOFTIRQ

8. 软中断对网卡进行轮询收包

   发生硬件中断，CPU会保存当前上下文，调用驱动程序。网络IO需要硬件处理，硬件中断不能嵌套（也就是不能再处理另一个硬件中断），收包是在软中断（指令性异常syscall等）中执行，CPU可以处理其他硬中断。网络流量很大就会经常触发中断，现在多采用半中断半轮训，轮训流量时就不用触发中断从而影响性能

9. 数据包放入qdisc队列

   通过对源地址和目的地址哈希，就能使一个网卡数据放到多个数据包队列，每个队列会绑定到不同CPU处理。

10. 数据包送入协议栈，调用ip_recv进入协议栈三层

11. 调用netfilter的PREROUTING链（工作在数据包路由前）

12. 查找路由表，进行转发或者投递到local

13. 投递到local的数据包，调用netfilter的LOCAL_IN链

14. 调用四层协议栈，如tcp_v4_rcv

15. 查找对应的socket，运行TCP的状态机

16. 将数据放入TCP的接受缓冲区中

17. 通过epoll或者其他轮训方式通知应用程序

18. 应用程序读取数据

### Linux协议栈发包流程

1. 应用层发送数据
2. TCP为发送数据申请skb
3. 构建TCP头部，如src的dst的port，checksum
4. 调用第三层，构建IP头部，调netfilter的LOCAL_OUT链
5. 查找路由表，本机or外部
6. 调用netfilter的POST_ROUTING链
7. 对超过MTU的报文进行分片（fragment），TCP不会超过，UDP会
8. 调用二层的发包函数
9. 将待发数据包放入QDisc队列
10. 调用网卡驱动，放入数据包的循环缓冲队列tx
11. 驱动程序在tx-usecs的超时时或积累tx-frames个待发数据包后触发软中断
12. 驱动程序启用硬件中断
13. 驱动程序将数据包映射到DMA内存
14. 网卡从DMA中取数据并发送
15. 网卡发送完毕后触发硬件中断
16. 硬中断清理中断信号后，触发软中断
17. 软中断释放已经发送完的数据包的内存 

### Linux防火墙

1. iptables：应用层规则管理工具和内核中的table模块（filter，nat）

   filter: 防火墙过滤规则

   nat：NAT的功能，网络地址转换，源和目的IP地址

   mangle：修改数据包内容

2. netfilter：Linux包过滤框架，提供数据包过滤和处理的基础设施，iptables通过调用其接口来修改内核中的tables

3. iptables命令

   - 设置规则

     iptables -t filter -A INPUT -p tcp --sport 80 -j ACCEPT

     可以操作3张表：filter、nat、mangle，默认时filter；-A：代表追加一条规则；INPUT代表使用的链：INPUT（本地处理）、FORWARD（转发）、OUTPUT（发送出去）；-p：指定协议；-j ACCEPT or DROP（丢掉数据）or REJECT（返回一个ICMP的错误报文，目的主机拒绝你）

   - 查看设置

     iptables -L -n [-t tab_name]查看设置

   - 清楚filter表的规则

     iptables -F

   - 设置默认策略

     iptables -p [INPUT|OUTPUT|FORWARD] [DROP|ACCEPT ]

   - 匹配IP地址

     iptables -A INPUT -s 10.10.10.0/24 -j DROP， 10.10.10.0/24这个网段下的数据包全部drop

   - 逻辑取反 

     ！ 表时not    `-s ! localhost` 表示所有不是来自本机的数据包

   - 高级扩展

     -p : 匹配协议和特殊模块功能

### HTTP历程

1. http/1.0 不能复用tcp连接，比如html里面需要js、css，它将会开多个连接。
2. http/1.1解决了1.0的问题，比如先请求html后再请求css，再请求logo.png，但是请求css阻塞了，后续则无法请求。
3. http/2.0 将文本协议改成2进制协议，数据包会分成多个帧，可以无序传输，最后再服务端组合，不会发生1.0那样头部阻塞。

